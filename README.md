# 99francs_platform
99francs Platform repository

**Домашняя работа №1 kubernetes-intro**

В рамках выполнения домашнего задания полученного после лекции 
"Знакомство с Kubernetes",была проделана следующая работа:
 - Создан образ веб сервера на базе официального образа Nginx работающего из-под пользователя с UID 1001
 - Образ веб сервера размещён на Docker Hub
 - Были найдены причины падения приложения fronted, а именно: не хватало целого списка переменных, 
 которые были найдены в подсказках с нужными значениями. После добавления, контейнер перешёл в статус Running

**Домашняя работа №2 kubernetes-controllers**

В рамках выполнения домашнего задания полученного после лекции "Механика запуска и взаимодействия контейнеров в Kubernetes",
была проделана следующая работа:
- Развернут kind по конфигу из Д/З
    ```yaml
    kind: Cluster
    apiVersion: kind.x-k8s.io/v1alpha4
    nodes:
      - role: control-plane
      - role: control-plane
      - role: control-plane
      - role: worker
      - role: worker
      - role: worker
    ```
- Ответ на вопрос из Д/З **Почему обновление ReplicaSet не повлекло обновление запущенных pod?:**
*ReplicaSet чувствителен к количеству запущенных реплик подов, которые матчатся по меткам с самим RS, тем самым игнорируя теги. Поэтому количество подов соответствующих метке app=fronted уже в нужном количестве, и перезапуск не требуется.* 

- Созданы образа **paymentservice** по аналогии с **frontend**, и запушил в docker hub.
- Созданы Deployment манифесты на базе Replicaset. 
- Созданы Deplyomet манифесты из задания со *, который имитируют сценарий blue/green и revers update   
- Создан манифест DaemonSet. Добавлена в манифест возможность запускаться на мастер-нодах

**Домашняя работа №3 kubernetes-security**

В рамках выполнения домашней работы, были созданы сервис аккаунты в кластере, а также присвоены им права

**Домашняя работа №4 kubernetes-networks**
В рамках Д/З сделано:
- Протестированы пробы жизни и пробы готовности принимать трафик.
- Осуществлена полноценная работа с типом развертывания Deployment
- Протестированы различные варианты параметры для деплоймента **maxUnavailable** и **maxSurge**. В качестве эксперимента применялись крайние значения для обоих
- Взаимодействие с самым распространенным типом **Service**  — **ClusterIP**. Данный тип является одним из самых распространенных, и имеет ряд ограничений
- Перенастройка minikube с использованием kube-proxy в режиме ipvs, т.к он имеет больше возможности для взаимодействия с сервисами.
 Например, присвоение IP из определенной сети, которая может быть доступна извне. Адреса из сети присваиваются на виртуальный интерфейс ноды
- Работа с L4 балансировщиком MetalLb
- Выполнение задачи со звёздочкой, а именно, проброс DNS-трафика в кластер при помощи MetalLB
- Деплой в minikube контроллера ingress-nginx  
- Протестирована работа Service без IP адресов
- Развертывание kubernetes-dasboard в minikube в контекстном пути **/dashboard**
- Выполнение задачи со звёздочкой: развертывание приложения с канареечным деплоем. 
В нашем случае канареечный деплой был реализован при помощи ingress-nginx и заголовков. 
В рамках данной задачи было создано два деплоймента, два сервиса и два ингресса с одинаковым хостом, но разными аннотациями.
Т.е. при обычном запросе трафик попадал на **web-app** приложение. 
В случае наличия в заголовке запросов header **canary: yes**, то данный запрос перенаправляется на **web-app-canary** приложение.

**Домашняя работа №5 kubernetes-volumes**

В рамках Д/З сделано:
- Развернут сервис minio из манифеста.
- Создан и подключен секрет с переменными окружения в зашифрованном виде

**Домашняя работа №5 kubernetes-templates**

В рамках Д/З было сделано:
- Развернут кластер GKE
- Установлены в GKE официальные чарты: ingress-nginx, cert-manager, harbor, chartmuseum
- Подключен letsencrypt clusterIssuer для cert-manager, чтобы через аннотации ingress можно было генерировать сертификаты
- При работе с chartmuseum, необходимо локально добавить репозиторий при помощи helm, и выполнить команду: 
```helm push mychart/ chartmuseum```
Либо при помощи curl отправить POST запрос
```curl --data-binary "@mychart-0.1.0.tgz" https://<ip-chartmuseum>:8080/api/chart```
- В задании по развертыванию HARBOR серьезный нюанс. 
Дело в том, чтобы в harbor попадать через ingress по https, необходимо запросить сертификат через issuer, но также для работы harbor требуется ca.crt, который не выдаётся letsencrypt. 
И как вариант, вручную добавить его, что и было сделано.
- Создан установлена утилита helmfile, для работы с созданным helmfile.yaml
- В рамках создания своего helm chart, было выполнено:
 разделение общего манифеста со всеми микросервисами, не несколько различных подходов для деплоя
 шаблонизация некоторых параметров, таких как: сервис, ингресс, образ
- Создана зависимость frontend для основного чарта hipster-shop
- Подключена дополнительная  зависимость устаревшим методом комьюнити чарта Redis
- Создан GPG ключ, и при помощи утилиты sops был зашифрован secret.yaml А при помощи плагина  helm secrets можно посмотреь содержимое secrets.yaml
- Сервисы paymentservice и shippingservice вынесены из helm chart для развертывания при помощи kubecfg
- kubecfg по сути является альтернативным шаблонизатором, и ему требуется: базовое описание генерируемых объектов, и описания параметров конечных объектов
- Задании со звёздочкой было выполнено с использованием инструмента qbec, он по сути очень сильно похож на Kubecfg. 
Установка выполнена из исходников.
В качестве вспомогательного инструмента, был инициализирован демонстрационный проект
```
qbec init common
```
qbec очень сильно похож на kubecfg, и также в json создается общий скелет генерируемых объектов, и отдельное описание подставляемых значений в шаблон
Проверить корректность шаблонов и значений, можно командой
```
qbec show default
```
Применить шаблоны в кластер
```yaml
qbec apply default
```
- Вынесен сервис redis-cart из чарта hipster-shop для развертывания при помощи kustomize. 
Сам инструмент по сути больше похож на kubecfg, но сильно упрощенная версия, и применяется в сулчае незначительных отличий при развертывании в разные окружения
